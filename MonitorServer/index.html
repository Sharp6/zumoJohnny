<html>
	<head>
		<title>Monitor Server J5 Zumo Robot System</title>
		
		<link rel='stylesheet' href='/stylesheets/bootstrap.min.css' />
	</head>

	<body>
		<div class="container">

			<h1>Games</h1>

			<div data-bind="foreach:games">
				<div class="panel panel-default">
				  <div class="panel-heading"><span data-bind="text:name"></span></div>
				  <div class="panel-body">
				  	<button class="btn btn-default" data-bind="click:startGame">Start game</button>
				    <p>
				    	Number of challenges: <span data-bind="text:numberOfChallenges"></span>
				    	<ul data-bind="foreach:challenges">
				    		<li>
				    			<span data-bind="text:name"></span>: asset <span data-bind="text:asset.assetId"></span> (<span data-bind="text:asset.type"></span>) - <span data-bind="text:state"></span> 
				    		</li>
				    	</ul>
				    </p>
				    <p>
				    	Available assets:
				    	<ul data-bind="foreach:assets">
				    		<li><span data-bind="text:assetId"></span> (<span data-bind="text:type"></span>)</li>
				    	</ul>
				    </p>
				  </div>
				</div>
			</div>

			<h3>New game</h3>
			<form data-bind="with:newGame">
				<div class="form-group">
			    <label for="newGameName">Game name</label>
			    <input type="text" id="newGameName" data-bind="value:name" class="form-control" />
			  </div>
				<div class="form-group">
			    <label for="newGameNumberOfChallenges">Number of challenges</label>
			    <input type="text" id="newGameNumberOfChallenges" data-bind="value:numberOfChallenges" class="form-control" />
			  </div>
			</form>
			<button class="btn btn-primary" data-bind="click:createGame">Create Game</button>

			<h3>Players</h3>

			<ul data-bind="foreach:players">
				<li>
					<span data-bind="text:name"></span>
				</li>
			</ul>

			<h5>New player</h5>
			<form data-bind="with:newPlayer">
				<div class="form-group">
			    <label for="newPlayerName">Name</label>
			    <input type="text" id="newPlayerName" data-bind="value:name" class="form-control" />
			  </div>
				
			</form>
			<button class="btn btn-primary" data-bind="click:createPlayer">Create Player</button>


			<h1>Assets</h1>
			<ul data-bind="foreach:assets">
				<li>
					<span data-bind="text:assetId"></span> (<span data-bind="text:type"></span>): <span data-bind="text:state"></span>.
				</li>
			</ul>

			
			<h1>Joystick mappings</h1>
			<div class="row" id="joysticks" data-bind="foreach:joysticks">
				<div class="col-s-6">
					<h3 data-bind="text:name"></h3>
					<form>
						<div class="input-field">
							<select data-bind="options:$parent.robots, optionsText: 'name', value: selectedRobot, optionsCaption: 'Select robot...'" class="browser-default" id="robotSelect"></select>
							<label for="robotSelect">Choose your bot</label>
						</div>
					</form>
					<p>
						<br />
						Mapped robot: <span data-bind="text:mappedRobot()? mappedRobot().name : 'none'"></span>
					</p>
					<button class="btn btn-default" data-bind="click:requestMapping">Map me!</button>
					<button class="btn btn-default" data-bind="click:requestMapRemoval">Remove mapping</button>
					<button class="btn btn-default" data-bind="click:monitorJoystick">Monitor joystick</button>
				</div>
			</div>
			
			<h1>Monitoring</h1>

			<table class="table">
				<tr class="titleRow">
					<th colspan="3">
						Firebutton
					</th>
				</tr>
				<tr>
					<th class="joystickLabel">State</th>
					<td colspan="2"><span id="fireButton">init</span></td>
				</tr>

				<tr class="titleRow">
					<th colspan="3">
						Joystick
					</th>
				</tr>
				<tr>
					<th></th>
					<th>X</th>
					<th>Y</th>
				</tr>
			
				<tr>
					<th class="joystickLabel">Raw Position</td>
					<td><span id="xPosRaw">init</span></td>
					<td><span id="yPosRaw">init</span></td>
				</tr>

				<tr>
					<th class="joystickLabel">Normalized Position</td>
					<td><span id="xPosNorm">init</span></td>
					<td><span id="yPosNorm">init</span></td>
				</tr>

				<tr>
					<th class="joystickLabel">Stick Extremes</td>
					<td><span id="xMin">init</span> - <span id="xMax">init</span></td>
					<td><span id="yMin">init</span> - <span id="yMax">init</span></td>
				</tr>

				<tr class="titleRow">
					<th colspan="3">
						P5.js
					</th>
				</tr>
				<tr>
					<td colspan="3" id="sketchCell"></td>
				</tr>
				
			</table>
		</div> <!-- Container //-->
		
		
		<script src="/socket.io/socket.io.js"></script>
		<script src="/libraries/jquery.js"></script>
		<script src="/libraries/bootstrap.min.js"></script>
		<script src="/libraries/p5.js"></script>
		<script src="/libraries/knockout.js"></script>

		<script>
			"use strict";
		  var socket = io();
		  var canvas;

		  var Joystick = function(name) {
		  	this.name = name;
		  	this.selectedRobot = ko.observable();
		  	this.mappedRobot = ko.observable();
		  	this.requestMapping = function() {
		  		console.log("Requesting mapping: ", this.name, this.selectedRobot().name);
		  		socket.emit('clientEvent', { action: 'requestMapping', joystick: this.name, robot: this.selectedRobot().name });
		  	};
		  	this.requestMapRemoval = function() {
		  		socket.emit('clientEvent', { action: 'requestMapRemoval', joystick: this.name });
		  	};
		  	this.monitorJoystick = function() {
		  		socket.emit('clientEvent', { action: 'monitorJoystick', joystick: this.name });
		  	};
		  };

		  var Robot = function(name) {
		  	this.name = name;
		  };

		  var Asset = function(data) {
		  	this.type = data.type;
		  	this.assetId = data.assetId;
		  	this.state = ko.observable("Unknown state");
		  };

		  var Player = function(data) {
		  	this.name = data.name;
		  	this.score = data.score ||Â "Unknown";
		  };

		  var Game = function(data) {
		  	this.name = data.name;
		  	this.numberOfChallenges = data.numberOfChallenges;
		  	this.state = ko.observable(data.state);

		  	this.players = data.players.map(function(playerData) {
		  		return players().find(function(player) {
		  			return player.name === playerData.name;
		  		});
		  	});
		  	this.assets = data.assets.map(function(assetData) {
		  		return assets().find(function(asset) {
		  			return asset.assetId === assetData.assetId;
		  		});
		  	});

		  	this.challenges = data.challenges.map(function(challegeData) {
		  		return new Challenge(challegeData);
		  	});

		  	this.startGame = function() {
		  		socket.emit('clientEvent', { action: 'startGame', gameName: this.name });
		  	}
		  };

		  var Challenge = function(data) {
		  	this.name = data.name;
		  	this.timeLimit = data.timeLimit;
		  	this.points = data.points;

		  	this.asset = assets().find(function(asset) { 
		  		return asset.assetId === data.asset.assetId;
		  	});
		  		
				this.player = players().find(function(player) {
					return player.name === data.player.name;
				});

		  	this.state = ko.observable(data.state);
		  };

			var joysticks = ko.observableArray([]);
			var robots = ko.observableArray([]);
			var assets = ko.observableArray([]);
			var players = ko.observableArray([]);
			var games = ko.observableArray([]);

			var newPlayer = {
				name: ko.observable()
			};

			var createPlayer = function() {
				console.log("CREATING PLAYER", { name: newPlayer.name() });
				socket.emit('clientEvent', { action: 'createPlayer', name: newPlayer.name() });
			};

			var newGame = {
				numberOfChallenges: ko.observable(),
				name: ko.observable()
			};

			var createGame = function() {
				console.log("CREATING GAME", { action:'createGame', assets: assets(), players: players(), numberOfChallenges: newGame.numberOfChallenges() });
				socket.emit('clientEvent', { action:'createGame', assets: assets(), players: players(), numberOfChallenges: newGame.numberOfChallenges() });
			};

		  socket.on("joysticks", function(data) {
		  	data.names.forEach(function(name) {
		  		joysticks.push(new Joystick(name));
		  	});
		  });

		  socket.on("robots", function(data) {
		  	data.names.forEach(function(name) {
		  		robots.push(new Robot(name));
		  	});
		  });

		  socket.on("bindingNotification", function(data) {
		  	var currentJoystick = joysticks().find(function(joystick) {
		  		return joystick.name === data.joystickName;
		  	});
		  	var currentRobot = robots().find(function(robot) {
		  		return robot.name === data.robotName;
		  	});
		  	currentJoystick.mappedRobot(currentRobot);
		  });

		  // PLAYERS
		  socket.on("newPlayer", function(data) {
		  	console.log("FRONT got new player", data);
		  	players.push(new Player(data));
		  });

		  // GAMES
		  socket.on("newGame", function(data) {
		  	console.log("FRONT got new game", data);
		  	games.push(new Game(data));
		  });

		  socket.on("gameStateChange", function(data) {
		  	var name = data.split("|")[0];
		  	var state = data.split("|")[1];

		  	var game = games().find(function(game) {
		  		return game.name === name;
		  	});
		  	game.state(state);
		  });

		  socket.on("challengeStateChange", function(data) {
		  	var challengeName = data.split("|")[0];
		  	var challengeState = data.split("|")[1];
		  	// get game
		  	var gameName = challengeName.split("Challenge")[0]; // challengeName is gameName + "challenge" + i in game constructor
		  	var game = games().find(function(game) {
		  		return game.name === gameName;
		  	});
		  	// get challenge
		  	var challenge = game.challenges.find(function(challenge) {
		  		return challenge.name === challengeName;
		  	});
		  	// update challenge
		  	challenge.state(challengeState);
		  });

		  // ASSETS
		  socket.on("newAsset", function(data) {
		  	console.log("FRONT got new asset", data);
		  	assets.push(new Asset(data));
		  });

		  socket.on("assetStateUpdate", function(data) {
		  	var assetId = data.split("|")[0];
		  	var state = data.split("|")[1];

		  	var asset = assets().find(function(asset) {
		  		return asset.assetId === assetId;
		  	});
		  	asset.state(state);
		  });

		  socket.on("assetDisconnected", function(assetId) {
		  	var asset = assets().find(function(asset) {
		  		return asset.assetId === assetId;
		  	});
		  	assets.splice(assets.indexOf(asset), 1);
		  });

			var vm = {
				joysticks: joysticks,
				robots: robots,
				assets: assets
			};
			ko.applyBindings(vm);

		  /*
		  $('#btn1').on('click', function (event) {
		  	socket.emit('clientEvent', { action: 'connectJoystick' });
		  });
		  $('#btn2').on('click', function (event) {
		  	socket.emit('clientEvent', { action: 'disconnectJoystick' });
		  });

		  socket.on("stickExtremesReport", function(msg) {
		  	$('#xMin').text(msg.x.min);
		  	$('#yMin').text(msg.y.min);
				$('#xMax').text(msg.x.max);
				$('#yMax').text(msg.y.max);
		  });

		  socket.on("rawPositionReport", function(msg) {
		  	$('#xPosRaw').text(msg.x);
		  	$('#yPosRaw').text(msg.y);
		  });

		  socket.on("normalizedPositionReport", function(msg) {
		  	$('#xPosNorm').text(msg.x);
		  	$('#yPosNorm').text(msg.y);
		  	drawCursor(msg);		  	
		  });

		  socket.on("fireButton", function(state) {
		  	$('#fireButton').text(state);
		  });

		  function drawCursor(data) {
		  	background(0, 0, 0);
		  	fill(0,255,10);
      	noStroke();
		  	ellipse(
		  		map(data.x, -255, 255, -100, 100),
		  		map(data.y, -255, 255, 100, -100),
		  		10,
		  		10
		  	);
		  }

		  function setup() {
				canvas = createCanvas(200, 200);
				canvas.parent('sketchCell');
				background(255, 0, 200);

				translate(100,100);
		  }

		  function draw() { }
		  */
		</script>

	</body>
</html>
