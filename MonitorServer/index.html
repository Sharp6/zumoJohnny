<html>
	<head>
		<title>Monitor Server J5 Zumo Robot System</title>
		<link rel='stylesheet' href='/stylesheets/monitor.css' />
	</head>

	<body>

		<h1>Monitoring</h1>

		<div id="joysticks" data-bind="foreach:joysticks">
			<div>
				<h3 data-bind="text:name"></h3>
				<select data-bind="options:$parent.robots, optionsText: 'name', value: selectedRobot, optionsCaption: 'Select robot...'"></select>
				<p>
					Selected robot: <span data-bind="text:selectedRobot()? selectedRobot().name : 'none yet'"></span>
					<br />
					Mapped robot: <span data-bind="text:mappedRobot()? mappedRobot().name : 'none yet'"></span>
				</p>
				<button data-bind="click:requestMapping">Map me!</button>
				<button data-bind="click:requestMapRemoval">Remove mapping</button>
				
			</div>
		</div>

		<script>
		/*
		<button id="btn1">Connect joystick</button>
		<button id="btn2">Disconnect joystick</button>

		<h2>Input</h2>

		<table>
			<tr class="titleRow">
				<th colspan="3">
					Firebutton
				</th>
			</tr>
			<tr>
				<th class="joystickLabel">State</th>
				<td colspan="2"><span id="fireButton">init</span></td>
			</tr>

			<tr class="titleRow">
				<th colspan="3">
					Joystick
				</th>
			</tr>
			<tr>
				<th></th>
				<th>X</th>
				<th>Y</th>
			</tr>
		
			<tr>
				<th class="joystickLabel">Raw Position</td>
				<td><span id="xPosRaw">init</span></td>
				<td><span id="yPosRaw">init</span></td>
			</tr>

			<tr>
				<th class="joystickLabel">Normalized Position</td>
				<td><span id="xPosNorm">init</span></td>
				<td><span id="yPosNorm">init</span></td>
			</tr>

			<tr>
				<th class="joystickLabel">Stick Extremes</td>
				<td><span id="xMin">init</span> - <span id="xMax">init</span></td>
				<td><span id="yMin">init</span> - <span id="yMax">init</span></td>
			</tr>

			<tr class="titleRow">
				<th colspan="3">
					P5.js
				</th>
			</tr>
			<tr>
				<td colspan="3" id="sketchCell"></td>
			</tr>
			
		</table>
		*/
		</script>
		
		<script src="/socket.io/socket.io.js"></script>
		<script src="/libraries/jquery.js"></script>
		<script src="/libraries/p5.js"></script>
		<script src="/libraries/knockout.js"></script>

		<script>
		  var socket = io();
		  var canvas;

		  var Joystick = function(name) {
		  	this.name = name;
		  	this.selectedRobot = ko.observable();
		  	this.mappedRobot = ko.observable();
		  	this.requestMapping = function() {
		  		console.log("Requesting mapping: ", this.name, this.selectedRobot().name);
		  		socket.emit('clientEvent', { action: 'requestMapping', joystick: this.name, robot: this.selectedRobot().name });
		  	};
		  	this.requestMapRemoval = function() {
		  		socket.emit('clientEvent', { action: 'requestMapRemoval', joystick: this.name });
		  	}
		  };

		  var Robot = function(name) {
		  	this.name = name;
		  };

			var joysticks = ko.observableArray([]);
			var robots = ko.observableArray([]);

		  socket.on("joysticks", function(data) {
		  	data.names.forEach(function(name) {
		  		joysticks.push(new Joystick(name));
		  	});
		  });

		  socket.on("robots", function(data) {
		  	data.names.forEach(function(name) {
		  		robots.push(new Robot(name));
		  	});
		  });

		  socket.on("bindingNotification", function(data) {
		  	var currentJoystick = joysticks().find(function(joystick) {
		  		return joystick.name === data.joystickName;
		  	});
		  	var currentRobot = robots.find(function(robot) {
		  		return robot.name === data.robotName;
		  	});
		  	currentJoystick.mappedRobot(currentRobot);
		  	/*
		  	if(data.isBound) {
		  		currentJoystick.mappedRobot(data.robotName);
		  	} else {
		  		currentJoystick.mappedRobot();
		  	}*/
		  });

			var vm = {
				joysticks: joysticks,
				robots: robots
			};
			ko.applyBindings(vm);

		  /*
		  $('#btn1').on('click', function (event) {
		  	socket.emit('clientEvent', { action: 'connectJoystick' });
		  });
		  $('#btn2').on('click', function (event) {
		  	socket.emit('clientEvent', { action: 'disconnectJoystick' });
		  });

		  socket.on("stickExtremesReport", function(msg) {
		  	$('#xMin').text(msg.x.min);
		  	$('#yMin').text(msg.y.min);
				$('#xMax').text(msg.x.max);
				$('#yMax').text(msg.y.max);
		  });

		  socket.on("rawPositionReport", function(msg) {
		  	$('#xPosRaw').text(msg.x);
		  	$('#yPosRaw').text(msg.y);
		  });

		  socket.on("normalizedPositionReport", function(msg) {
		  	$('#xPosNorm').text(msg.x);
		  	$('#yPosNorm').text(msg.y);
		  	drawCursor(msg);		  	
		  });

		  socket.on("fireButton", function(state) {
		  	$('#fireButton').text(state);
		  });

		  function drawCursor(data) {
		  	background(0, 0, 0);
		  	fill(0,255,10);
      	noStroke();
		  	ellipse(
		  		map(data.x, -255, 255, -100, 100),
		  		map(data.y, -255, 255, 100, -100),
		  		10,
		  		10
		  	);
		  }

		  function setup() {
				canvas = createCanvas(200, 200);
				canvas.parent('sketchCell');
				background(255, 0, 200);

				translate(100,100);
		  }

		  function draw() { }
		  */
		</script>

	</body>
</html>
